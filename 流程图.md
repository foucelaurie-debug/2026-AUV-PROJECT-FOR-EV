# DeviceManager 单片机功能 / 处理 / 通信 / 协议 / 时序流程图

> 使用方式：直接把本文件当作 Markdown 打开，在支持 Mermaid 的工具中即可看到流程图。

```mermaid
flowchart TD

%% ================= 上电 & 初始化 =================
subgraph POWERUP[上电 & 初始化]
    P0[上电复位]
    P1[HAL_Init & SystemClock_Config]
    P2[初始化外设\nGPIO / ADC1 / I2C1 / TIM4 / UART4 / UART5]
    P3[SHTC3 传感器初始化\nDev_Shtc3_init()]
    P4[启动 PWM\nTIM4_CH3 → 舵机\nTIM4_CH4 → 电磁铁]
    P5[开启 UART4 中断接收\nHAL_UART_Receive_IT(UART4, 1B)]
    P6[点亮 LED1~4 (上电指示)]

    P0 --> P1 --> P2 --> P3 --> P4 --> P5 --> P6
end

%% 主循环入口
P6 --> M0

%% ================= 主循环 =================
subgraph MAINLOOP[主循环 while(1)]
    M0[进入 while(1)]

    M1[读取温湿度\nDev_Shtc3_Refresh()\n→ Temp / Hum]
    M2[读取电池电压\nDev_Voltage_Refresh(ADC1-CH3)\n- 记录 200 次中的最大值\n- 每 200 次更新 Voltage*10000]
    M3[漏水检测 WaterCheck(GPIOB0)\n- 连续≥20 次低电平 → Leak=1\n- 否则 Leak=0]
    M4[根据控制变量驱动执行机构\n- 舵机 PWM: TIM4_CH3\n- 电磁铁 PWM: TIM4_CH4]
    M5[填充状态结构体 DeviceStatus\nLeak / Voltage / Temp / Hum\nState=magnet_state\nangle[0/1]=servo[0/1]]
    M6[打包上行帧 (MCU → AGX)\n0xFA 0xAF 0x01 + Status(22B) + 0xFB 0xBF\n通过 UART4 发送]
    M7[翻转 LED1 作为心跳灯]

    M0 --> M1 --> M2 --> M3 --> M4 --> M5 --> M6 --> M7 --> M0
end

%% ================= UART4 接收 & 协议解析 =================
subgraph UART4RX[UART4 接收 & 协议解析（AGX → MCU）]
    R0[UART4 接收中断\nHAL_UART_RxCpltCallback()]
    R1[状态机累积到 uart_buff\n- 寻找帧头 0xFA 0xAF\n- 检测帧尾 0xFB 0xBF\n得到一帧完整命令]
    R2{根据 uart_buff[2]\n判断命令 ID}

    R0 --> R1 --> R2

    %% 舵机控制
    R2 -->|ID = 0x06 舵机控制| C_SERVO
    C_SERVO[解析舵机命令\n- 通道: uart_buff[3]\n  0x00 → 舵机0\n  0x01 → 舵机1\n- Servo_angle = float(uart_buff[4..7])\n→ servo[channel] = Servo_angle\n(建议 0.0 ~ 1.0)]

    %% 电磁铁控制
    R2 -->|ID = 0x09 电磁铁控制| C_MAG
    C_MAG[解析电磁铁命令\n- uart_buff[3] = 0 → magnet_state=0 (关)\n- uart_buff[3] ≠0 → magnet_state=1 (开)]

    %% DVL 开关
    R2 -->|ID = 0x04 DVL 控制| C_DVL
    C_DVL{uart_buff[3]\n控制字节}
    C_DVL -->|= 1| DVL_ON
    C_DVL -->|= 0| DVL_OFF

    DVL_ON[dvl_startup(UART5)\n发送 14B 启动命令给 DVL]
    DVL_OFF[dvl_shutdown(UART5)\n发送 14B 关闭命令给 DVL]
end

%% ================= 系统级交互视图 =================
subgraph SYSTEM[系统级交互 / 协议 / 时序]
    AGX[AGX + ROS 节点\n/ttyUSB0 @115200]
    MCU[F407 DeviceManager\nUART4@115200 / UART5@256000]
    SENS[传感器\n- 电池电压 ADC1-CH3\n- SHTC3 I2C1\n- 漏水 GPIOB0]
    ACT[执行机构\n- 舵机 TIM4_CH3\n- 电磁铁 TIM4_CH4]
    DVL[DVL 速度计\nUART5]

    %% AGX 与 MCU
    AGX <-->|周期接收状态帧\n0xFA 0xAF 0x01 + Status + 0xFB 0xBF| MCU
    AGX -->|按需下发控制帧\nID=0x06 舵机\nID=0x09 电磁铁\nID=0x04 DVL 开关| MCU

    %% MCU 与传感器/执行机构/DVL
    MCU -->|周期采集\nTemp / Hum / Voltage / Leak| SENS
    MCU -->|PWM 输出控制\n舵机 / 电磁铁| ACT
    MCU -->|收到 DVL 控制 ID=0x04\n经 UART5 发送 14B 启动/关闭帧| DVL
end

%% ===== 将各模块串起来（逻辑关系） =====
P0 --> UART4RX
P0 --> SYSTEM
